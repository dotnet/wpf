<Project>
  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.GenAPI" Version="$(MicrosoftDotNetGenAPIVersion)" GeneratePathProperty="true"
                      Condition="'$(GenerateReferenceAssemblySource)'=='true'"/>
  </ItemGroup>

  <PropertyGroup Condition="'$(GenerateReferenceAssemblySource)'=='true'">
    <!-- 
      By default, GenAPI's target (GenerateReferenceAssemblySource) generates code into $(TargetDir).
      Instead, WPF generates into the ref directory in the project's source tree.
    -->
    <GenAPITargetDir>$(IntermediateOutputPath)ref\</GenAPITargetDir>
    <GenAPITargetPath>$(GenAPITargetDir)$(AssemblyName).cs</GenAPITargetPath>
  </PropertyGroup>
  
  <Target Name="EnsureGenAPITargetDirectory"
          BeforeTargets="GenerateReferenceAssemblySource"
          Condition="!Exists('$(GenAPITargetDir)')">
    <MakeDir Directories="$(GenAPITargetDir)" />
  </Target>

  <PropertyGroup>
    <TaskFactory>RoslynCodeTaskFactory</TaskFactory>
    <TaskFactoryAssemblyFile>$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll</TaskFactoryAssemblyFile>
  </PropertyGroup>

  <ItemGroup>
    <TaskFactoryReference Include="mscorlib" />
    <TaskFactoryReference Include="netstandard" />
  </ItemGroup>

  <!-- 
    Defines a task to create a reference assembly project using the current building project's 
    csproj as a template.
  -->
  <UsingTask TaskName="GenerateReferenceAssemblyProjectTask"
             TaskFactory="$(TaskFactory)"
             AssemblyFile="$(TaskFactoryAssemblyFile)">
    <ParameterGroup>
      <CurrentProjectFile ParameterType="System.String" Required="true"/>
      <ReferenceAssemblyProjectFile ParameterType="System.String" Required="true"/>
    </ParameterGroup>
    <Task>
      <Code Type="Class" Language="cs" Source="$(WpfArcadeSdkToolsDir)GenApi\GenerateReferenceAssemblyProjectTask.cs" />
    </Task>
  </UsingTask>

  <!-- 
    Generates a reference assembly project that builds the generated sources from GenAPI.
  -->
  <Target Name="BuildReferenceAssemblyFromSource"
          AfterTargets="GenerateReferenceAssemblySource"
          Condition="'$(GenerateReferenceAssemblySource)' == 'true'" >

    <PropertyGroup>
      <ReferenceAssemblyProjectFile>$(IntermediateOutputPath)ref\$(MSBuildProjectName)-ref.csproj</ReferenceAssemblyProjectFile>
    </PropertyGroup>

    <MakeDir Condition="!Exists('$(IntermediateOutputPath)ref\')"
             Directories="$(IntermediateOutputPath)ref\" />

    <Delete Files="$(ReferenceAssemblyProjectFile)" Condition="Exists('$(ReferenceAssemblyProjectFile)')" />

    <GenerateReferenceAssemblyProjectTask
             CurrentProjectFile="$(MSBuildProjectFullPath)"
             ReferenceAssemblyProjectFile="$(ReferenceAssemblyProjectFile)" />

    <ItemGroup>
      <ProjectToBuild Remove="@(ProjectToBuild)" />
      <ProjectToBuild Include="$(ReferenceAssemblyProjectFile)" />
    </ItemGroup>
    
    <MSBuild Projects="@(ProjectToBuild)"
             Targets="Restore;Build"
             Properties="TargetFramework=$(TargetFramework);Platform=$(Platform);RuntimeIdentifier=$(RuntimeIdentifier);IsShipping=true;EnableXlfLocalization=false"/>
  </Target>

</Project>
