trigger:
  batch: true 
  branches:
    include: 
    - main
    - release/*
    - internal/release/*
    - experimental/*
  paths:
    exclude:
    - Documentation/*

pr:
  autoCancel: true
  branches:
    include:
    - main
    - release/* 
    - experimental/*
    - feature/win11theming/staging
    - feature/win11theming/release
  paths:
    exclude:
    - Documentation/*

variables:
- name: repoName
  value: dotnet/wpf

stages:
- stage: build
  displayName: Build 
  jobs:
  - template: /eng/common/templates/jobs/jobs.yml@self
    parameters:
      enablePublishBuildArtifacts: true
      enablePublishTestResults: false
      enablePublishBuildAssets: false
      enablePublishUsingPipelines: false
      enableTelemetry: true
      helixRepo: $(repoName)

      jobs:
      - job: Windows_NT
        timeoutInMinutes: 120  # how long to run the job before automatically cancelling; see https://github.com/dotnet/wpf/issues/952
        pool:
          # For public jobs, use the hosted pool.  For internal jobs use the internal pool.
          # Will eventually change this to two BYOC pools.
          # agent pool can't be read from a user-defined variable (Azure DevOps limitation)
          ${{ if eq(variables['System.TeamProject'], 'public') }}:
            name: NetCore-Public
            demands: ImageOverride -equals windows.vs2026preview.scout.amd64.Open
          ${{ if eq(variables['System.TeamProject'], 'internal') }}:
            name: NetCore1ESPool-Internal
            demands: ImageOverride -equals windows.vs2026preview.scout.amd64
        variables:
        - name: _Platform
          value: x86
        - name: _PlatformArgs
          value: /p:Platform=$(_Platform)
        - name: _TestHelixAgentPool
          value: 'Windows.10.Amd64.ClientRS5.Open' # Preferred:'Windows.10.Amd64.Open%3bWindows.7.Amd64.Open%3bWindows.10.Amd64.ClientRS5.Open'; See https://github.com/dotnet/wpf/issues/952
        - name: _HelixStagingDir
          value: $(BUILD.STAGINGDIRECTORY)\helix\functests
        - name: _HelixSource
          value: $(repoName)/$(Build.SourceBranch)
        - name: _HelixToken
          value: ''
        - name: _HelixCreator
          value: $(repoName)
        - name: _programfilesx86
          value: ${Env:ProgramFiles(x86)}/dotnet
        - name: _programfiles
          value:  ${Env:ProgramFiles}/dotnet
        - ${{ if ne(variables['System.TeamProject'], 'internal') }}:
          - name: _InternalRuntimeDownloadArgs
            value: ''
        - ${{ if eq(variables['System.TeamProject'], 'internal') }}:
          - group: AzureDevOps-Artifact-Feeds-Pats
          - group: DotNet-HelixApi-Access
          - name: _InternalRuntimeDownloadArgs
            value: >-
              /p:DotNetRuntimeSourceFeed=https://ci.dot.net/internal
              /p:DotNetRuntimeSourceFeedKey=$(dotnetbuilds-internal-container-read-token-base64)
          - name: _HelixSource
            value: official/$(repoName)/$(Build.SourceBranch)
          - name: _HelixToken
            value: '$(HelixApiAccessToken)' # from DotNet-HelixApi-Access group
          - name: _HelixCreator
            value: '' #if _HelixToken is set, Creator must be empty
          - name: _TestHelixAgentPool
            value: 'Windows.10.Amd64.ClientRS5' # Preferred: 'Windows.10.Amd64%3bWindows.7.Amd64%3bWindows.10.Amd64.ClientRS5'

        strategy:
          matrix:
            # Build_Debug_x86:
            #   _BuildConfig: Debug
            # Build_Release_x86:
            #   _BuildConfig: Release
            # Build_Debug_x64:
            #   _BuildConfig: Debug
            #   _Coverage: true
            #   # override some variables for debug
            #   # _SignType has to be real for package publishing to succeed - do not override to test.
            #   _Platform: x64
            # Build_Release_x64:
            #   _BuildConfig: Release
            #   _Platform: x64
            Build_Debug_arm64:
              _BuildConfig: Debug
              # override some variables for debug
              # _SignType has to be real for package publishing to succeed - do not override to test.
              _Platform: arm64
            Build_Release_arm64:
              _BuildConfig: Release
              _Platform: arm64
        steps:
        # Set VSO Variable(s)
        - powershell: eng\pre-build.ps1
          displayName: Pre-Build - Set VSO Variables

        # Check installed VS components
        - powershell: |
            $vsWherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
            
            if (Test-Path $vsWherePath) {
              Write-Host "Checking installed Visual Studio components..."
              $vsPath = & "$vsWherePath" -latest -prerelease -property installationPath
              Write-Host "VS Installation Path: $vsPath"
              
              Write-Host "`nInstalled components:"
              & "$vsWherePath" -latest -prerelease -format json | ConvertFrom-Json | ForEach-Object {
                if ($_.packages) {
                  $_.packages | Where-Object { $_.id -like "*ARM64*" -or $_.id -like "*ATL*" } | ForEach-Object {
                    Write-Host "  - $($_.id) (Version: $($_.version))"
                  }
                }
              }
            } else {
              Write-Warning "vswhere.exe not found at $vsWherePath"
            }
          displayName: Check Installed VS Components
          condition: eq(variables['_Platform'], 'arm64')

        # Install ARM64 ATL components
        - powershell: |
            $vsInstallerPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vs_installer.exe"
            $vsInstallPath = "C:\Program Files\Microsoft Visual Studio\18\Insiders"
            
            if (Test-Path $vsInstallerPath) {
              Write-Host "##[section]Installing ARM64 ATL components..."
              Write-Host "VS Installer: $vsInstallerPath"
              Write-Host "VS Install Path: $vsInstallPath"
              
              $components = @(
                "Microsoft.VisualStudio.Component.VC.ATL.ARM64",
                "Microsoft.VisualStudio.Component.VC.14.50.18.0.ATL.ARM64"
              )
              
              Write-Host "`nComponents to install:"
              $components | ForEach-Object { Write-Host "  - $_" }
              
              $addArgs = $components | ForEach-Object { "--add", $_ }
              $allArgs = @("modify", "--installPath", $vsInstallPath) + $addArgs + @("--norestart", "--wait")
              
              Write-Host "`nExecuting: vs_installer.exe $($allArgs -join ' ')"
              Write-Host "##[command]& `"$vsInstallerPath`" $($allArgs -join ' ')"
              
              $output = & "$vsInstallerPath" $allArgs 2>&1 | Tee-Object -Variable installerOutput
              $output | ForEach-Object { Write-Host $_ }
              
              $exitCode = $LASTEXITCODE
              Write-Host "`n##[section]Installation completed with exit code: $exitCode"
              
              if ($exitCode -eq 0) {
                Write-Host "##[section]Installation succeeded"
              } elseif ($exitCode -eq 3010) {
                Write-Host "##[warning]Installation succeeded but requires restart (exit code 3010)"
              } else {
                Write-Host "##[error]Installation failed with exit code $exitCode"
                Write-Host "##[error]Installer output: $installerOutput"
                exit $exitCode
              }
            } else {
              Write-Host "##[error]VS Installer not found at $vsInstallerPath"
              exit 1
            }
          displayName: Install ARM64 ATL Components
          condition: eq(variables['_Platform'], 'arm64')

        - template: /eng/common/templates/steps/enable-internal-sources.yml
        - template: /eng/common/templates/steps/enable-internal-runtimes.yml

        # Use utility script to run script command dependent on agent OS.
        - script: eng\scripts\cibuild.cmd
            -configuration $(_BuildConfig)
            -prepareMachine
            $(_PlatformArgs)
            $(_InternalRuntimeDownloadArgs)
            /p:Coverage=$(_Coverage)
          displayName: Windows Build / Publish

        - script: eng\scripts\ciunittest.cmd
            -configuration $(_BuildConfig)
            -prepareMachine
            $(_PlatformArgs)
            $(_InternalRuntimeDownloadArgs)
            /bl:$(Build.SourcesDirectory)\artifacts\log\$(_BuildConfig)\Test.binlog
            /p:Coverage=$(_Coverage)
          displayName: Run xUnit Tests
          condition: eq(variables['_Platform'], 'x64')

        - task: PublishTestResults@2
          displayName: Publish XUnit Test Results
          inputs:
            testRunner: VSTest
            testResultsFiles: '$(Build.SourcesDirectory)/artifacts/TestResults/$(_BuildConfig)/*.trx'
            mergeTestResults: true
          condition: and(succeededOrFailed(), eq(variables['_BuildConfig'], 'Debug'), eq(variables['_Platform'], 'x64'))
            
        # Upload code coverage data
        - script: dotnet msbuild -binaryLogger:artifacts\log\$(_BuildConfig)\uploadCodeCov.binlog;ProjectImports=Embed -restore eng/CodeCoverage.proj
          displayName: Upload coverage to codecov.io
          condition: and(succeeded(), eq(variables['_Coverage'], True), eq(variables['_BuildConfig'], 'Debug'), eq(variables['_Platform'], 'x64'))
