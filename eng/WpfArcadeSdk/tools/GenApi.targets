<Project>
  <ItemGroup>
    <PackageReference Include="Microsoft.DotNet.GenAPI" Version="$(MicrosoftDotNetGenAPIVersion)" GeneratePathProperty="true"
                      Condition="'$(_GenerateReferenceAssemblySource)'=='true'"/>
  </ItemGroup>

  <PropertyGroup Condition="'$(_GenerateReferenceAssemblySource)'=='true'">
    <!-- 
      By default, GenAPI's target (GenerateReferenceAssemblySource) generates code into $(TargetDir).
      Instead, WPF generates into the ref directory in the project's source tree.
    -->
    <GenAPITargetDir>$(MSBuildProjectDir)ref\</GenAPITargetDir>
    <GenAPITargetPath>$(GenAPITargetDir)$(AssemblyName).cs</GenAPITargetPath>
  </PropertyGroup>
  
  <Target Name="EnsureGenAPITargetDirectory"
          BeforeTargets="GenerateReferenceAssemblySource"
          Condition="!Exists('$(GenAPITargetDir)')">
    <MakeDir Directories="$(GenAPITargetDir)" />
  </Target>

  <PropertyGroup>
    <TaskFactory>RoslynCodeTaskFactory</TaskFactory>
    <TaskFactoryAssemblyFile>$(MSBuildToolsPath)\Microsoft.Build.Tasks.Core.dll</TaskFactoryAssemblyFile>
  </PropertyGroup>

  <ItemGroup>
    <TaskFactoryReference Include="mscorlib" />
    <TaskFactoryReference Include="netstandard" />
  </ItemGroup>

  <!-- 
    Defines a task to create a reference assembly project using the current building project's 
    csproj as a template.
  -->
  <UsingTask TaskName="GenerateReferenceAssemblyProjectTask"
             TaskFactory="$(TaskFactory)"
             AssemblyFile="$(TaskFactoryAssemblyFile)">
    <ParameterGroup>
      <CurrentProjectFile ParameterType="System.String" Required="true"/>
      <ReferenceAssemblyProjectFile ParameterType="System.String" Required="true"/>
    </ParameterGroup>
    <Task>
      <Code Type="Class" Language="cs" Source="$(WpfArcadeSdkToolsDir)GenApi\GenerateReferenceAssemblyProjectTask.cs" />
    </Task>
  </UsingTask>

  <!-- 
    Generates a reference assembly project that builds the generated sources from GenAPI.
    TODO:  This is just being used as a one off to help creation, remove this before merge.
  -->
  <Target Name="GenerateReferenceAssemblyProjectFromRuntimeProject"
          AfterTargets="GenerateReferenceAssemblySource"
          Condition="'$(_GenerateReferenceAssemblyProject)' == 'true'" >

    <PropertyGroup>
      <ReferenceAssemblyProjectFile>$(GenAPITargetDir)$(MSBuildProjectName)-ref.g.csproj</ReferenceAssemblyProjectFile>
    </PropertyGroup>

    <MakeDir Condition="!Exists('$(GenAPITargetDir)')"
             Directories="$(GenAPITargetDir)" />

    <Delete Files="$(ReferenceAssemblyProjectFile)" Condition="Exists('$(ReferenceAssemblyProjectFile)')" />

    <GenerateReferenceAssemblyProjectTask
             CurrentProjectFile="$(MSBuildProjectFullPath)"
             ReferenceAssemblyProjectFile="$(ReferenceAssemblyProjectFile)" />

    <ItemGroup>
      <ProjectToBuild Remove="@(ProjectToBuild)" />
      <ProjectToBuild Include="$(ReferenceAssemblyProjectFile)" />
    </ItemGroup>
  
  </Target>

</Project>
